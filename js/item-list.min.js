!function(t,o){'use strict';function i(t,e){var n=this;e=e||{},n.options=o.extend({i18n:ccm_xan.i18n,items:[],maxItemsCount:0},e),n.$element=t.addClass('ccm-block-edit-container'),n.$container=t.find('.ccm-item-list'),n._templateItem=_.template(o('#itemTemplate'+e.bID).html()),n.loadItems(),n.setupItemHeaderAction(),n.setupDeleteItemAction(),n.setupAddItemAction(),n.$container.sortable({handle:'.panel-heading',update:function(){n.doSortCount()}}),n.$element.closest('.ui-dialog').on('dialogclose',function(t){n.destroyRichTextEditors(n.$container)})}i.prototype={getNewItemDefaults:function(t){return{sortOrder:t}},loadItems:function(){var e=this,t=e.options.items;t&&0!==t.length&&(t.forEach(function(t){e.addItem(t)}),e.doSortCount())},addItem:function(t){var e=this;e.$container.append(e._templateItem({item:t}));var n=e.$container.find('.ccm-item-entry').last();return e.initPageSelectors(n),e.initFileSelectors(n),e.initRichTextEditors(n),e.detectCheckboxes(n),e.setupChoiceToggler(n),e.extraItemLoad&&e.extraItemLoad(n,t),void 0!==e.options.extraItemLoad&&e.options.extraItemLoad(n,t),n},setupItemHeaderAction:function(){this.$container.on('click','.ccm-item-entry > .panel-heading',function(){o(this).parent().find('.panel-body').toggle()})},setupDeleteItemAction:function(){var e=this;e.$container.on('click','.btn-delete-item',function(t){t.preventDefault(),t.stopPropagation(),confirm(e.options.i18n.confirm)&&o(this).closest('.ccm-item-entry').hide('fade',function(){e.destroyRichTextEditors(o(this)),o(this).remove(),e.doSortCount()})})},setupAddItemAction:function(){var o=this;o.$element.find('.ccm-add-item-entry').click(function(){var t=o.$container.find('.ccm-item-entry').length;if(0<o.options.maxItemsCount&&t>=o.options.maxItemsCount)return alert(o.options.i18n.maxItemsExceeded),!1;var e=void 0!==o.options.getNewItemDefaults?o.options.getNewItemDefaults(t):o.getNewItemDefaults(t),n=o.addItem(e);if(n.find('.panel-heading').trigger('click'),o.doSortCount(),0<o.$element.closest('.ui-dialog.ui-widget').find('.floating-block-actions').length){var i=n.position().top;o.$container.parent().hasClass('ccm-block-edit-container')||(i+=o.$container.parent().position().top),o.$element.closest('.ui-dialog-content.ui-widget-content').animate({scrollTop:i},'slow')}}),0<o.$element.find('.floating-block-actions').length&&o.$element.find('.floating-block-actions').appendTo(o.$element.closest('.ui-dialog.ui-widget'))},setupChoiceToggler:function(i){i.find('[data-choice]').each(function(){var n=o(this).data('choice');o(this).change(function(t){var e=i.find('[data-choice-group="'+n+'"]');e.hide(),e.filter('[data-choice-value="'+o(this).val()+'"]').show()}).trigger('change')})},initPageSelectors:function(t){var e=this;t.find('div[data-field=page-selector]').each(function(){o(this).xanPageSelector({inputName:o(this).data('name'),cID:parseInt(o(this).data('value')),onChange:e.options.onSelectPage})})},initFileSelectors:function(t){var e=this;t.find('div[data-field=file-selector]').each(function(){o(this).xanFileSelector({inputName:o(this).data('name'),fID:parseInt(o(this).data('value')),onChange:e.options.onSelectFile})})},initRichTextEditors:function(t){var e=t.find('.editor-content');0<e.length&&(e.each(function(){o(this).attr('id')||o(this).attr('id',_.uniqueId('editor'))}),ccm_xan.editor.initCompactEditor(e))},destroyRichTextEditors:function(t){t.find('.editor-content').each(function(){var t=o(this).attr('id');o(this).remove(),void 0!==CKEDITOR.instances[t]&&(o('#cke_'+t).remove(),CKEDITOR.instances[t].destroy(!1))})},detectCheckboxes:function(t){t.find('.checkbox').each(function(t){var e=o(this).find('[type="checkbox"]');'1'==e.val()&&(e.parent().append('<input type="hidden" name="'+e.attr('name')+'" >'),e.removeAttr('name'),e.change(function(t){o(this).is(':checked')?e.parent().find('input[type="hidden"]').val(1):e.parent().find('input[type="hidden"]').val(0)}).trigger('change'))})},doSortCount:function(){this.$container.find('.ccm-item-entry').each(function(t){o(this).find('.ccm-item-entry-sort').val(t)})}},o.fn.xanItemList=function(n){return o.each(o(this),function(t,e){new i(o(this),n)})},t.XanItemList=i}(window,$);